<script type="text/javascript">
  var generateMediaRow = function(name, value, thumb, label, checked) {
    var template = [
        "<li>",
            "<label for='id_<<name>>_<<value>>'>",
                "<img src='<<thumb>>' width='50' height='50' />",
                "<input id='id_<<name>>_<<value>>' name='<<name>>' type='checkbox' value='<<value>>' required='' <<checked>> > <<label>>",
            "</label>",
        "</li>"
    ].join('\n');
    template = template.replace(/<<name>>/g, name);
    template = template.replace(/<<value>>/g, value);
    template = template.replace(/<<thumb>>/g, thumb);
    template = template.replace(/<<label>>/g, label);
    template = template.replace(/<<checked>>/g, checked);
    return template
  };
</script>

<ul id="id_checkbox_{{name}}" class="media-select-multiple">
</ul>

<input type="hidden" id="id_{{name}}">

<script type="text/javascript">
    setTimeout(function() {
      (function($) {

        {% for choice in choices %}
        var row = generateMediaRow(
          '{{name}}', '{{choice.value}}',
          '{{choice.thumb}}', '{{choice.label}}',
          {% if choice.selected %}'checked'{%else%}''{% endif %}
        );
        $("#id_checkbox_{{name}}").append(row);
        {% endfor %}

        if (!window._dismissAddRelatedObjectPopup) {
            window._dismissAddRelatedObjectPopup = window.dismissAddRelatedObjectPopup;
        }

        window.dismissAddRelatedObjectPopup = function (win, newId, newRepr) {
          var name = windowname_to_id(win.name);
          var elem = document.getElementById(name);
          if (elem) {
              $(elem).data('repr', JSON.parse(newRepr));
          }
          window._dismissAddRelatedObjectPopup(win, newId, newRepr);
        }

        $('#id_{{name}}').on('change', function(e) {
          var data = $(this).data().repr;
          var row = generateMediaRow('{{name}}', data.id, data.thumbnail, data.label, 'checked');
          var row_not_checked = generateMediaRow('{{name}}', data.id, data.thumbnail, data.label, '');
          $("#id_checkbox_{{name}}").append(row)
          $(".media-select-multiple").each(function () {
            if ($(this).attr('id') != 'id_checkbox_{{name}}') {
              $(this).append(row_not_checked);
            }
          });
        });

      })(django.jQuery);
    }, 50);
</script>
